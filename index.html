<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ouverture √† la concurrence des lignes ferroviaires fran√ßaises</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        #header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #header h1 { font-size: 24px; margin-bottom: 8px; }
        #header p { font-size: 14px; opacity: 0.9; }
        #map { height: calc(100vh - 100px); width: 100%; }
        #legend { position: absolute; bottom: 30px; right: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000; max-width: 350px; }
        #legend h3 { margin: 0 0 15px 0; font-size: 16px; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 8px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 12px; }
        .legend-line { width: 40px; height: 4px; margin-right: 12px; border-radius: 2px; }
        .legend-text { font-size: 13px; color: #555; flex: 1; }
        .legend-count { font-size: 12px; color: #888; background: #f0f0f0; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-weight: 600; }
        .leaflet-popup-content { margin: 15px; min-width: 280px; }
        .popup-title { font-weight: bold; font-size: 16px; color: #333; margin-bottom: 10px; border-bottom: 2px solid #667eea; padding-bottom: 5px; }
        .popup-info { font-size: 13px; line-height: 1.6; color: #555; }
        .popup-row { display: flex; margin: 6px 0; }
        .popup-label { font-weight: 600; color: #667eea; min-width: 90px; }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .status-sncf { background: #4CAF50; color: white; }
        .status-concurrent { background: #2196F3; color: white; }
        .status-encours { background: #FF9800; color: white; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px 50px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 2000; text-align: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="header">
        <h1>üöÜ Ouverture √† la concurrence des lignes ferroviaires fran√ßaises</h1>
        <p>√âtat des lignes TER et TET (hors √éle-de-France et Corse) - Trac√©s r√©els - Source: Contexte, novembre 2025</p>
    </div>
    <div id="loading"><div class="spinner"></div><div>Chargement de la carte...</div></div>
    <div id="map"></div>
    <div id="legend">
        <h3>L√©gende</h3>
        <div class="legend-item">
            <div class="legend-line" style="background: #4CAF50;"></div>
            <span class="legend-text">Attribu√© √† la SNCF</span>
            <span class="legend-count" id="count-sncf">0</span>
        </div>
        <div class="legend-item">
            <div class="legend-line" style="background: #2196F3;"></div>
            <span class="legend-text">Attribu√© √† un concurrent</span>
            <span class="legend-count" id="count-concurrent">0</span>
        </div>
        <div class="legend-item">
            <div class="legend-line" style="background: #FF9800;"></div>
            <span class="legend-text">Mis en concurrence (non attribu√©)</span>
            <span class="legend-count" id="count-encours">0</span>
        </div>
        <hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">
        <div style="font-size: 12px; color: #666;"><strong>Trac√©s affich√©s:</strong> <span id="total-lines">0</span></div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([46.603354, 2.888334], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);
        
        const statusColors = {
            'attribue_SNCF': '#4CAF50',
            'attribue_concurrent': '#2196F3',
            'mis_en_concurrence_pas_attribue': '#FF9800'
        };
        
        const statusLabels = {
            'attribue_SNCF': 'Attribu√© √† la SNCF',
            'attribue_concurrent': 'Attribu√© √† un concurrent',
            'mis_en_concurrence_pas_attribue': 'Mis en concurrence (non attribu√©)'
        };
        
        function createPopup(ligne, regionVisu) {
            const operateur = ligne.operateur || 'Non attribu√©';
            const statusClass = ligne.statut === 'attribue_SNCF' ? 'status-sncf' : 
                                ligne.statut === 'attribue_concurrent' ? 'status-concurrent' : 'status-encours';
            return `<div class="popup-title">${ligne.relation}</div>
                <div class="popup-info">
                    <div class="popup-row"><span class="popup-label">R√©gion:</span><span class="popup-value">${ligne.region}</span></div>
                    <div class="popup-row"><span class="popup-label">Type:</span><span class="popup-value">${ligne.type_marche}</span></div>
                    <div class="popup-row"><span class="popup-label">Lot:</span><span class="popup-value">${ligne.lot}</span></div>
                    <div class="popup-row"><span class="popup-label">Statut:</span><span class="status-badge ${statusClass}">${statusLabels[ligne.statut]}</span></div>
                    ${operateur !== 'Non attribu√©' ? `<div class="popup-row"><span class="popup-label">Op√©rateur:</span><span class="popup-value">${operateur}</span></div>` : ''}
                    <hr style="margin: 8px 0;"><div style="font-size: 11px; color: #888;">Trac√© de la r√©gion: ${regionVisu}</div>
                </div>`;
        }
        
        fetch('railway_data_complete.json')
            .then(response => response.json())
            .then(data => {
                const tracesByRegion = data.traces_par_region;
                const regionMapping = data.region_mapping;
                const etatLignes = data.etat_lignes;
                
                // Cr√©er un index: pour chaque ancienne r√©gion, quel statut?
                const regionStatus = {};
                etatLignes.forEach(ligne => {
                    const anciennes = regionMapping[ligne.region] || [ligne.region];
                    anciennes.forEach(old => {
                        if (old === '*') {
                            // Toutes les r√©gions
                            Object.keys(tracesByRegion).forEach(r => {
                                if (!regionStatus[r]) regionStatus[r] = [];
                                regionStatus[r].push(ligne);
                            });
                        } else {
                            if (!regionStatus[old]) regionStatus[old] = [];
                            regionStatus[old].push(ligne);
                        }
                    });
                });
                
                let totalTraces = 0;
                const counts = { 'attribue_SNCF': 0, 'attribue_concurrent': 0, 'mis_en_concurrence_pas_attribue': 0 };
                
                // Afficher les trac√©s des r√©gions concern√©es
                Object.entries(regionStatus).forEach(([regionName, lignesInfo]) => {
                    const traces = tracesByRegion[regionName];
                    if (!traces) return;
                    
                    // D√©terminer le statut dominant (priorit√©: concurrent > SNCF > en_concurrence)
                    let dominantStatus = null;
                    if (lignesInfo.some(l => l.statut === 'attribue_concurrent')) {
                        dominantStatus = 'attribue_concurrent';
                    } else if (lignesInfo.some(l => l.statut === 'attribue_SNCF')) {
                        dominantStatus = 'attribue_SNCF';
                    } else {
                        dominantStatus = 'mis_en_concurrence_pas_attribue';
                    }
                    
                    const color = statusColors[dominantStatus];
                    const ligneRepresentative = lignesInfo.find(l => l.statut === dominantStatus) || lignesInfo[0];
                    
                    // Afficher les trac√©s
                    traces.forEach(trace => {
                        const simplified = trace.coords.filter((_, i) => i % 2 === 0 || i === trace.coords.length - 1);
                        const latLngs = simplified.map(c => [c[1], c[0]]);
                        
                        if (latLngs.length >= 2) {
                            const polyline = L.polyline(latLngs, {
                                color: color,
                                weight: 3,
                                opacity: 0.7
                            });
                            polyline.bindPopup(createPopup(ligneRepresentative, regionName));
                            polyline.addTo(map);
                            totalTraces++;
                        }
                    });
                });
                
                // Compter les lignes par statut
                etatLignes.forEach(ligne => counts[ligne.statut]++);
                
                document.getElementById('count-sncf').textContent = counts['attribue_SNCF'];
                document.getElementById('count-concurrent').textContent = counts['attribue_concurrent'];
                document.getElementById('count-encours').textContent = counts['mis_en_concurrence_pas_attribue'];
                document.getElementById('total-lines').textContent = totalTraces;
                document.getElementById('loading').style.display = 'none';
                
                console.log('Carte charg√©e!');
                console.log('Trac√©s affich√©s:', totalTraces);
                console.log('Lignes r√©f√©renc√©es:', etatLignes.length);
            })
            .catch(error => {
                console.error('Erreur:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: #d32f2f;"><h3>Erreur de chargement</h3><p>${error.message}</p></div>
                `;
            });
    </script>
</body>
</html>
